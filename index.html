<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>情侣宠物</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Arial', sans-serif;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            color: #333;
            overflow-x: hidden;
        }
        
        .container {
            flex: 1;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            overflow-y: auto;
            position: relative;
            padding-bottom: 70px;
        }
        
        .page {
            width: 100%;
            max-width: 500px;
            background-color: white;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            padding: 20px;
            margin-bottom: 20px;
            display: none;
        }
        
        .page.active {
            display: block;
        }
        
        .header {
            text-align: center;
            margin-bottom: 20px;
            position: relative;
        }
        
        .header h2 {
            color: #FF69B4;
            font-size: 1.5rem;
            margin-bottom: 5px;
        }
        
        .header p {
            color: #888;
            font-size: 0.9rem;
        }
        
        .code-container {
            display: flex;
            align-items: center;
            justify-content: center;
            margin-top: 15px;
        }
        
        .room-code {
            font-size: 18px;
            font-weight: bold;
            letter-spacing: 2px;
            padding: 5px 10px;
            background-color: #f8f9fa;
            border-radius: 5px;
            border: 1px dashed #ccc;
            margin-right: 10px;
        }
        
        .copy-btn {
            background-color: transparent;
            border: none;
            color: #666;
            cursor: pointer;
            font-size: 16px;
        }
        
        .settings-btn {
            position: absolute;
            right: 0;
            top: 0;
            background: none;
            border: none;
            font-size: 1.2rem;
            color: #888;
            cursor: pointer;
        }
        
        /* 3D容器样式 */
        #canvasContainer {
            width: 100%;
            height: 250px;
            margin: 0 auto 20px;
            position: relative;
        }
        
        canvas {
            width: 100%;
            height: 100%;
            border-radius: 15px;
            background: radial-gradient(circle, rgba(255,255,255,0.9) 0%, rgba(240,240,255,0.6) 100%);
            box-shadow: 0 5px 15px rgba(0,0,0,0.05);
        }
        
        .pet-stats {
            display: flex;
            justify-content: space-around;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        .stat-card {
            padding: 10px 15px;
            background-color: #f8f9fa;
            border-radius: 10px;
            text-align: center;
            width: 30%;
            margin-bottom: 10px;
        }
        
        .stat-card .value {
            font-size: 1.2rem;
            font-weight: bold;
            color: #FF69B4;
            margin-top: 5px;
        }
        
        .stat-card .label {
            font-size: 0.8rem;
            color: #888;
        }
        
        .action-buttons {
            display: flex;
            justify-content: space-around;
            flex-wrap: wrap;
            margin-bottom: 20px;
        }
        
        .action-btn {
            width: 30%;
            background-color: #FF69B4;
            color: white;
            border: none;
            padding: 12px 0;
            font-size: 0.9rem;
            border-radius: 50px;
            cursor: pointer;
            transition: all 0.3s;
            margin-bottom: 10px;
            box-shadow: 0 5px 15px rgba(255,105,180,0.2);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
        
        .action-btn i {
            font-size: 1.2rem;
            margin-bottom: 5px;
        }
        
        .action-btn:hover {
            background-color: #FF1493;
            transform: translateY(-3px);
        }
        
        .action-btn:active {
            transform: translateY(0);
        }
        
        .action-btn:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }
        
        .activity-log {
            background-color: #f8f9fa;
            border-radius: 10px;
            padding: 15px;
            max-height: 150px;
            overflow-y: auto;
            margin-bottom: 20px;
        }
        
        .log-title {
            font-weight: bold;
            margin-bottom: 10px;
            color: #666;
            font-size: 0.9rem;
        }
        
        .log-entry {
            padding: 8px 0;
            border-bottom: 1px solid #eee;
            font-size: 0.85rem;
            color: #777;
        }
        
        .log-entry:last-child {
            border-bottom: none;
        }
        
        .log-time {
            font-size: 0.75rem;
            color: #aaa;
        }
        
        /* 底部导航栏 */
        .nav-bar {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            background-color: white;
            display: flex;
            justify-content: space-around;
            padding: 10px 0;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
            z-index: 1000;
        }
        
        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            color: #888;
            text-decoration: none;
            font-size: 0.8rem;
            cursor: pointer;
        }
        
        .nav-item i {
            font-size: 1.3rem;
            margin-bottom: 3px;
        }
        
        .nav-item.active {
            color: #FF69B4;
        }
        
        /* 教程页面 */
        .tutorial-card {
            background-color: #f8f9fa;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
        }
        
        .tutorial-title {
            font-weight: bold;
            margin-bottom: 10px;
            color: #FF69B4;
        }
        
        .tutorial-text {
            font-size: 0.9rem;
            color: #666;
            line-height: 1.5;
        }
        
        /* 我的页面 */
        .profile-section {
            text-align: center;
            margin-bottom: 20px;
        }
        
        .avatar {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background-color: #eee;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 15px;
            font-size: 2rem;
            color: #FF69B4;
        }
        
        .username {
            font-size: 1.2rem;
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .pair-info {
            font-size: 0.9rem;
            color: #888;
        }
        
        .settings-section {
            margin-top: 20px;
        }
        
        .setting-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px 0;
            border-bottom: 1px solid #eee;
        }
        
        .setting-item:last-child {
            border-bottom: none;
        }
        
        .setting-label {
            display: flex;
            align-items: center;
        }
        
        .setting-label i {
            margin-right: 10px;
            color: #666;
            width: 20px;
            text-align: center;
        }
        
        /* 模态框 */
        .modal {
            display: none;
            position: fixed;
            z-index: 1001;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            align-items: center;
            justify-content: center;
        }
        
        .modal-content {
            background-color: white;
            padding: 20px;
            border-radius: 15px;
            width: 90%;
            max-width: 350px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }
        
        .modal-header {
            text-align: center;
            margin-bottom: 20px;
        }
        
        .modal-title {
            color: #FF69B4;
            font-size: 1.2rem;
        }
        
        .modal-body {
            margin-bottom: 20px;
        }
        
        .input-group {
            margin-bottom: 15px;
        }
        
        .input-label {
            display: block;
            margin-bottom: 5px;
            font-size: 0.9rem;
            color: #666;
        }
        
        .text-input {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 1rem;
        }
        
        .modal-footer {
            display: flex;
            justify-content: space-between;
        }
        
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.9rem;
        }
        
        .primary-btn {
            background-color: #FF69B4;
            color: white;
        }
        
        .secondary-btn {
            background-color: #f1f1f1;
            color: #666;
        }
        
        /* 加载提示 */
        .loading {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(255,255,255,0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            flex-direction: column;
        }
        
        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #FF69B4;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 15px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* 消息提示 */
        .toast {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background-color: rgba(0,0,0,0.7);
            color: white;
            padding: 10px 20px;
            border-radius: 5px;
            z-index: 2001;
            font-size: 0.9rem;
            opacity: 0;
            transition: opacity 0.3s;
        }
        
        .toast.show {
            opacity: 1;
        }
        
        /* 响应式布局 */
        @media (max-width: 400px) {
            .action-btn {
                width: 45%;
            }
            
            .stat-card {
                width: 45%;
            }
        }
    </style>
</head>
<body>
    <!-- 主页 -->
    <div class="container">
        <div id="homePage" class="page active">
            <div class="header">
                <h2>情侣守护宠物</h2>
                <p>每日互动，让爱持续</p>
                <button class="settings-btn" id="settingsBtn">
                    <i class="fas fa-cog"></i>
                </button>
            </div>
            
            <div class="code-container">
                <div class="room-code" id="roomCode">--</div>
                <button class="copy-btn" id="copyBtn">
                    <i class="fas fa-copy"></i>
                </button>
            </div>
            
            <div id="canvasContainer"></div>
            
            <div class="pet-stats">
                <div class="stat-card">
                    <div class="label">火花天数</div>
                    <div class="value" id="daysCount">0</div>
                </div>
                <div class="stat-card">
                    <div class="label">爱心</div>
                    <div class="value" id="loveValue">100</div>
                </div>
                <div class="stat-card">
                    <div class="label">饱食度</div>
                    <div class="value" id="foodValue">100</div>
                </div>
            </div>
            
            <div class="action-buttons">
                <button class="action-btn" id="sparkBtn">
                    <i class="fas fa-heart"></i>
                    续火花
                </button>
                <button class="action-btn" id="feedBtn">
                    <i class="fas fa-utensils"></i>
                    喂食
                </button>
                <button class="action-btn" id="playBtn">
                    <i class="fas fa-gamepad"></i>
                    玩耍
                </button>
            </div>
            
            <div class="activity-log">
                <div class="log-title">互动记录</div>
                <div id="logContainer">
                    <!-- 日志条目将在这里动态添加 -->
                </div>
            </div>
        </div>
        
        <!-- 教程页面 -->
        <div id="tutorialPage" class="page">
            <div class="header">
                <h2>使用教程</h2>
                <p>了解如何使用情侣守护宠物</p>
            </div>
            
            <div class="tutorial-card">
                <div class="tutorial-title">如何连接伴侣</div>
                <div class="tutorial-text">
                    1. 在主页复制房间代码<br>
                    2. 将代码发送给你的伴侣<br>
                    3. 伴侣输入代码后就可以连接到同一个宠物<br>
                    两人连接后，每天都需要至少一方进行"续火花"操作
                </div>
            </div>
            
            <div class="tutorial-card">
                <div class="tutorial-title">每日互动很重要</div>
                <div class="tutorial-text">
                    如果有一天双方都没有"续火花"，宠物就会消失。记得每天花一点时间来维持你们的火花！
                </div>
            </div>
            
            <div class="tutorial-card">
                <div class="tutorial-title">如何照顾宠物</div>
                <div class="tutorial-text">
                    你可以定期给宠物喂食和陪它玩耍，这样可以增加宠物的爱心值和饱食度。宠物心情好了，表现也会更可爱哦！
                </div>
            </div>
            
            <div class="tutorial-card">
                <div class="tutorial-title">关于通知</div>
                <div class="tutorial-text">
                    每天会有通知提醒你"续火花"，别忘了允许浏览器通知哦！
                </div>
            </div>
        </div>
        
        <!-- 我的页面 -->
        <div id="profilePage" class="page">
            <div class="header">
                <h2>个人信息</h2>
                <p>管理你的账号和设置</p>
            </div>
            
            <div class="profile-section">
                <div class="avatar" id="avatarContainer">
                    <i class="fas fa-user"></i>
                </div>
                <div class="username" id="usernameDisplay">未设置昵称</div>
                <div class="pair-info" id="pairInfo">未配对</div>
            </div>
            
            <div class="settings-section">
                <div class="setting-item" id="changeNameBtn">
                    <div class="setting-label">
                        <i class="fas fa-edit"></i>
                        <span>修改昵称</span>
                    </div>
                    <i class="fas fa-chevron-right"></i>
                </div>
                
                <div class="setting-item" id="enterRoomBtn">
                    <div class="setting-label">
                        <i class="fas fa-door-open"></i>
                        <span>加入房间</span>
                    </div>
                    <i class="fas fa-chevron-right"></i>
                </div>
                
                <div class="setting-item" id="createRoomBtn">
                    <div class="setting-label">
                        <i class="fas fa-plus-circle"></i>
                        <span>创建新房间</span>
                    </div>
                    <i class="fas fa-chevron-right"></i>
                </div>
                
                <div class="setting-item" id="notificationBtn">
                    <div class="setting-label">
                        <i class="fas fa-bell"></i>
                        <span>通知设置</span>
                    </div>
                    <i class="fas fa-toggle-on"></i>
                </div>
                
                <div class="setting-item" id="aboutBtn">
                    <div class="setting-label">
                        <i class="fas fa-info-circle"></i>
                        <span>关于应用</span>
                    </div>
                    <i class="fas fa-chevron-right"></i>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 底部导航栏 -->
    <div class="nav-bar">
        <div class="nav-item active" data-page="homePage">
            <i class="fas fa-home"></i>
            <span>主页</span>
        </div>
        <div class="nav-item" data-page="tutorialPage">
            <i class="fas fa-book"></i>
            <span>教程</span>
        </div>
        <div class="nav-item" data-page="profilePage">
            <i class="fas fa-user"></i>
            <span>我的</span>
        </div>
    </div>
    
    <!-- 加入房间模态框 -->
    <div id="joinRoomModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">加入房间</div>
            </div>
            <div class="modal-body">
                <div class="input-group">
                    <label class="input-label">输入房间代码</label>
                    <input type="text" class="text-input" id="roomCodeInput" placeholder="例如: ABC123">
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn secondary-btn" id="cancelJoinBtn">取消</button>
                <button class="btn primary-btn" id="confirmJoinBtn">加入</button>
            </div>
        </div>
    </div>
    
    <!-- 修改昵称模态框 -->
    <div id="changeNameModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">修改昵称</div>
            </div>
            <div class="modal-body">
                <div class="input-group">
                    <label class="input-label">输入新昵称</label>
                    <input type="text" class="text-input" id="nameInput" placeholder="你的昵称">
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn secondary-btn" id="cancelNameBtn">取消</button>
                <button class="btn primary-btn" id="confirmNameBtn">保存</button>
            </div>
        </div>
    </div>
    
    <!-- 宠物死亡模态框 -->
    <div id="deathModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">宠物离开了</div>
            </div>
            <div class="modal-body">
                <p>因为你们有一天没有互动，宠物已经离开了。</p>
                <p>你们持续互动了 <span id="finalDays">0</span> 天。</p>
            </div>
            <div class="modal-footer">
                <button class="btn primary-btn" id="adoptNewBtn">重新领养</button>
            </div>
        </div>
    </div>
    
    <!-- 加载提示 -->
    <div id="loading" class="loading" style="display: none;">
        <div class="spinner"></div>
        <div id="loadingText">加载中...</div>
    </div>
    
    <!-- 消息提示 -->
    <div id="toast" class="toast"></div>
    
    <!-- 引入Three.js库 -->
    <script src="https://cdn.jsdelivr.net/npm/three@0.132.2/build/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.132.2/examples/js/loaders/GLTFLoader.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.132.2/examples/js/controls/OrbitControls.js"></script>
    
    <!-- 引入Firebase客户端库 -->
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
    
    <script>
        const firebaseConfig = {
    apiKey: "AIzaSyDeV6WClmPOjlIlKYnrbjDmXzPH8xfZGc0",
    authDomain: "ifou-aed8d.firebaseapp.com",
    projectId: "ifou-aed8d",
    storageBucket: "ifou-aed8d.firebasestorage.app",
    messagingSenderId: "102878943260",
    appId: "1:102878943260:web:cbfb590fe8fba8d52027d9",
    measurementId: "G-D8B70MK64T"
  };
        
        // 初始化Firebase
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
        
        // DOM元素
        const pages = document.querySelectorAll('.page');
        const navItems = document.querySelectorAll('.nav-item');
        const roomCodeElem = document.getElementById('roomCode');
        const copyBtn = document.getElementById('copyBtn');
        const daysCountElem = document.getElementById('daysCount');
        const loveValueElem = document.getElementById('loveValue');
        const foodValueElem = document.getElementById('foodValue');
        const sparkBtn = document.getElementById('sparkBtn');
        const feedBtn = document.getElementById('feedBtn');
        const playBtn = document.getElementById('playBtn');
        const logContainer = document.getElementById('logContainer');
        const enterRoomBtn = document.getElementById('enterRoomBtn');
        const createRoomBtn = document.getElementById('createRoomBtn');
        const changeNameBtn = document.getElementById('changeNameBtn');
        const usernameDisplay = document.getElementById('usernameDisplay');
        const pairInfo = document.getElementById('pairInfo');
        const joinRoomModal = document.getElementById('joinRoomModal');
        const roomCodeInput = document.getElementById('roomCodeInput');
        const confirmJoinBtn = document.getElementById('confirmJoinBtn');
        const cancelJoinBtn = document.getElementById('cancelJoinBtn');
        const changeNameModal = document.getElementById('changeNameModal');
        const nameInput = document.getElementById('nameInput');
        const confirmNameBtn = document.getElementById('confirmNameBtn');
        const cancelNameBtn = document.getElementById('cancelNameBtn');
        const deathModal = document.getElementById('deathModal');
        const finalDays = document.getElementById('finalDays');
        const adoptNewBtn = document.getElementById('adoptNewBtn');
        const loading = document.getElementById('loading');
        const loadingText = document.getElementById('loadingText');
        const toast = document.getElementById('toast');
        const notificationBtn = document.getElementById('notificationBtn');
        
        // 应用状态
        let currentState = {
            username: '未设置昵称',
            roomCode: null,
            partnerName: null,
            daysStreak: 0,
            loveValue: 100,
            foodValue: 100,
            lastInteractionDate: null,
            todayInteracted: false,
            isAlive: true,
            logs: []
        };
        
        // 当前页面
        let currentPage = 'homePage';
        
        // 显示页面
        function showPage(pageId) {
            pages.forEach(page => {
                page.classList.remove('active');
            });
            document.getElementById(pageId).classList.add('active');
            
            navItems.forEach(item => {
                item.classList.remove('active');
                if (item.dataset.page === pageId) {
                    item.classList.add('active');
                }
            });
            
            currentPage = pageId;
        }
        
        // 导航点击事件
        navItems.forEach(item => {
            item.addEventListener('click', () => {
                showPage(item.dataset.page);
            });
        });
        
        // 生成随机房间码
        function generateRoomCode() {
            const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
            let result = '';
            for (let i = 0; i < 6; i++) {
                result += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            return result;
        }
        
        // 显示加载状态
        function showLoading(message = '加载中...') {
            loadingText.textContent = message;
            loading.style.display = 'flex';
        }
        
        // 隐藏加载状态
        function hideLoading() {
            loading.style.display = 'none';
        }
        
        // 显示消息提示
        function showToast(message, duration = 2000) {
            toast.textContent = message;
            toast.classList.add('show');
            setTimeout(() => {
                toast.classList.remove('show');
            }, duration);
        }
        
        // 创建新房间
        function createRoom() {
            showLoading('创建新房间...');
            
            const newRoomCode = generateRoomCode();
            currentState.roomCode = newRoomCode;
            roomCodeElem.textContent = newRoomCode;
            
            // 初始化房间数据
            const roomData = {
                created: firebase.database.ServerValue.TIMESTAMP,
                members: {},
                pet: {
                    isAlive: true,
                    daysStreak: 0,
                    loveValue: 100,
                    foodValue: 100,
                    lastInteractionDate: new Date().toISOString(),
                    logs: []
                }
            };
            
            // 将用户添加到成员列表
            roomData.members[generateUserId()] = {
                username: currentState.username,
                joinedAt: firebase.database.ServerValue.TIMESTAMP
            };
            
            // 保存到Firebase
            database.ref('rooms/' + newRoomCode).set(roomData)
                .then(() => {
                    subscribeToRoomChanges(newRoomCode);
                    saveUserData();
                    hideLoading();
                    showToast('房间创建成功，请将代码分享给你的伴侣');
                })
                .catch(error => {
                    console.error('Error creating room:', error);
                    hideLoading();
                    showToast('创建房间失败，请重试');
                });
        }
        
        // 加入现有房间
        function joinRoom(roomCode) {
            showLoading('加入房间...');
            
            // 检查房间是否存在
            database.ref('rooms/' + roomCode).once('value')
                .then(snapshot => {
                    if (!snapshot.exists()) {
                        hideLoading();
                        showToast('房间不存在，请检查代码');
                        return;
                    }
                    
                    const roomData = snapshot.val();
                    const membersCount = Object.keys(roomData.members || {}).length;
                    
                    if (membersCount >= 2) {
                        hideLoading();
                        showToast('房间已满，无法加入');
                        return;
                    }
                    
                    // 添加用户到房间成员
                    const userId = generateUserId();
                    database.ref('rooms/' + roomCode + '/members/' + userId).set({
                        username: currentState.username,
                        joinedAt: firebase.database.ServerValue.TIMESTAMP
                    }).then(() => {
                        currentState.roomCode = roomCode;
                        roomCodeElem.textContent = roomCode;
                        subscribeToRoomChanges(roomCode);
                        saveUserData();
                        hideLoading();
                        showToast('成功加入房间');
                    }).catch(error => {
                        console.error('Error joining room:', error);
                        hideLoading();
                        showToast('加入房间失败，请重试');
                    });
                })
                .catch(error => {
                    console.error('Error checking room:', error);
                    hideLoading();
                    showToast('检查房间失败，请重试');
                });
        }
        
        // 订阅房间变化
        function subscribeToRoomChanges(roomCode) {
            // 取消之前的订阅（如果有）
            database.ref('rooms/' + roomCode).off();
            
            // 监听房间数据变化
            database.ref('rooms/' + roomCode).on('value', snapshot => {
                if (!snapshot.exists()) {
                    showToast('房间已不存在');
                    return;
                }
                
                const roomData = snapshot.val();
                updateStateFromRoom(roomData);
                updateUI();
            });
        }
        
        // 从房间数据更新状态
        function updateStateFromRoom(roomData) {
            if (!roomData || !roomData.pet) return;
            
            // 更新宠物状态
            currentState.isAlive = roomData.pet.isAlive;
            currentState.daysStreak = roomData.pet.daysStreak || 0;
            currentState.loveValue = roomData.pet.loveValue || 100;
            currentState.foodValue = roomData.pet.foodValue || 100;
            currentState.lastInteractionDate = roomData.pet.lastInteractionDate;
            currentState.logs = roomData.pet.logs || [];
            
            // 检查是否今天已互动
            checkTodayInteraction();
            
            // 更新伴侣信息
            updatePartnerInfo(roomData.members);
        }
        
        // 更新伴侣信息
        function updatePartnerInfo(members) {
            const memberIds = Object.keys(members || {});
            
            if (memberIds.length > 1) {
                // 找到不是自己的成员
                const userId = generateUserId();
                for (const memberId of memberIds) {
                    if (memberId !== userId) {
                        currentState.partnerName = members[memberId].username;
                        break;
                    }
                }
            } else {
                currentState.partnerName = null;
            }
            
            // 更新UI显示
            pairInfo.textContent = currentState.partnerName ? 
                `已与 ${currentState.partnerName} 配对` : '未配对';
        }
        
        // 检查今天是否已互动
        function checkTodayInteraction() {
            if (!currentState.lastInteractionDate) {
                currentState.todayInteracted = false;
                return;
            }
            
            const lastDate = new Date(currentState.lastInteractionDate);
            const today = new Date();
            
            // 检查日期是否是今天
            currentState.todayInteracted = 
                lastDate.getDate() === today.getDate() && 
                lastDate.getMonth() === today.getMonth() && 
                lastDate.getFullYear() === today.getFullYear();
        }
        
        // 更新UI显示
        function updateUI() {
            // 更新统计数据
            daysCountElem.textContent = currentState.daysStreak;
            loveValueElem.textContent = currentState.loveValue;
            foodValueElem.textContent = currentState.foodValue;
            
            // 更新房间代码
            if (currentState.roomCode) {
                roomCodeElem.textContent = currentState.roomCode;
            } else {
                roomCodeElem.textContent = '--';
            }
            
            // 更新按钮状态
            sparkBtn.disabled = currentState.todayInteracted || !currentState.isAlive;
            feedBtn.disabled = !currentState.isAlive;
            playBtn.disabled = !currentState.isAlive;
            
            // 更新个人信息
            usernameDisplay.textContent = currentState.username;
            
            // 更新活动日志
            updateActivityLog();
            
            // 检查宠物状态
            checkPetStatus();
            
            // 更新3D宠物状态
            updatePetAnimation();
        }
        
        // 更新活动日志
        function updateActivityLog() {
            logContainer.innerHTML = '';
            
            // 如果没有日志记录，显示默认信息
            if (!currentState.logs || currentState.logs.length === 0) {
                const emptyLog = document.createElement('div');
                emptyLog.className = 'log-entry';
                emptyLog.textContent = '暂无互动记录';
                logContainer.appendChild(emptyLog);
                return;
            }
            
            // 显示最近的5条记录
            const recentLogs = [...currentState.logs].reverse().slice(0, 5);
            
            for (const log of recentLogs) {
                const logEntry = document.createElement('div');
                logEntry.className = 'log-entry';
                
                const logTime = new Date(log.timestamp);
                const timeStr = logTime.toLocaleString('zh-CN', {
                    month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit'
                });
                
                logEntry.innerHTML = `
                    <span>${log.message}</span>
                    <div class="log-time">${timeStr}</div>
                `;
                
                logContainer.appendChild(logEntry);
            }
        }
        
        // 检查宠物状态
        function checkPetStatus() {
            if (!currentState.isAlive) {
                // 显示死亡模态框
                finalDays.textContent = currentState.daysStreak;
                deathModal.style.display = 'flex';
                return;
            }
            
            if (currentState.lastInteractionDate) {
                const lastDate = new Date(currentState.lastInteractionDate);
                const today = new Date();
                lastDate.setHours(0, 0, 0, 0);
                today.setHours(0, 0, 0, 0);
                
                const timeDiff = today.getTime() - lastDate.getTime();
                const dayDiff = Math.floor(timeDiff / (1000 * 3600 * 24));
                
                if (dayDiff > 1) {
                    // 超过一天没互动，宠物死亡
                    killPet();
                }
            }
        }
        
        // 宠物死亡
        function killPet() {
            if (!currentState.roomCode) return;
            
            database.ref('rooms/' + currentState.roomCode + '/pet/isAlive').set(false)
                .then(() => {
                    addLog('宠物因为缺少互动而离开了');
                })
                .catch(error => {
                    console.error('Error updating pet status:', error);
                });
        }
        
        // 重新领养宠物
        function adoptNewPet() {
            if (!currentState.roomCode) return;
            
            showLoading('重新领养宠物...');
            
            const updates = {
                'isAlive': true,
                'daysStreak': 0,
                'loveValue': 100,
                'foodValue': 100,
                'lastInteractionDate': new Date().toISOString()
            };
            
            database.ref('rooms/' + currentState.roomCode + '/pet').update(updates)
                .then(() => {
                    addLog('领养了新宠物');
                    deathModal.style.display = 'none';
                    hideLoading();
                    showToast('成功领养新宠物');
                })
                .catch(error => {
                    console.error('Error adopting new pet:', error);
                    hideLoading();
                    showToast('领养失败，请重试');
                });
        }
        
        // 续火花
        function spark() {
            if (!currentState.roomCode || !currentState.isAlive || currentState.todayInteracted) return;
            
            showLoading('续火花中...');
            
            const now = new Date();
            const today = new Date(now);
            today.setHours(0, 0, 0, 0);
            
            let newDaysStreak = 1;
            
            if (currentState.lastInteractionDate) {
                const lastDate = new Date(currentState.lastInteractionDate);
                lastDate.setHours(0, 0, 0, 0);
                
                const timeDiff = today.getTime() - lastDate.getTime();
                const dayDiff = Math.floor(timeDiff / (1000 * 3600 * 24));
                
                if (dayDiff === 1) {
                    // 连续的下一天
                    newDaysStreak = currentState.daysStreak + 1;
                }
            }
            
            const updates = {
                'daysStreak': newDaysStreak,
                'lastInteractionDate': now.toISOString()
            };
            
            database.ref('rooms/' + currentState.roomCode + '/pet').update(updates)
                .then(() => {
                    addLog(`${currentState.username} 续了火花`);
                    currentState.todayInteracted = true;
                    hideLoading();
                    showToast('续火花成功');
                })
                .catch(error => {
                    console.error('Error updating spark:', error);
                    hideLoading();
                    showToast('操作失败，请重试');
                });
        }
        
        // 喂食
        function feed() {
            if (!currentState.roomCode || !currentState.isAlive) return;
            
            showLoading('喂食中...');
            
            // 最大值为100
            const newFoodValue = Math.min(currentState.foodValue + 20, 100);
            
            database.ref('rooms/' + currentState.roomCode + '/pet/foodValue').set(newFoodValue)
                .then(() => {
                    addLog(`${currentState.username} 给宠物喂食了`);
                    hideLoading();
                    showToast('喂食成功');
                })
                .catch(error => {
                    console.error('Error feeding pet:', error);
                    hideLoading();
                    showToast('操作失败，请重试');
                });
        }
        
        // 玩耍
        function play() {
            if (!currentState.roomCode || !currentState.isAlive) return;
            
            showLoading('玩耍中...');
            
            // 最大值为100
            const newLoveValue = Math.min(currentState.loveValue + 15, 100);
            
            database.ref('rooms/' + currentState.roomCode + '/pet/loveValue').set(newLoveValue)
                .then(() => {
                    addLog(`${currentState.username} 和宠物玩耍了`);
                    hideLoading();
                    showToast('玩耍成功');
                })
                .catch(error => {
                    console.error('Error playing with pet:', error);
                    hideLoading();
                    showToast('操作失败，请重试');
                });
        }
        
        // 添加日志
        function addLog(message) {
            if (!currentState.roomCode) return;
            
            const log = {
                message: message,
                timestamp: new Date().toISOString()
            };
            
            // 添加到Firebase
            const logsRef = database.ref('rooms/' + currentState.roomCode + '/pet/logs');
            logsRef.once('value')
                .then(snapshot => {
                    let logs = snapshot.val() || [];
                    logs.push(log);
                    
                    // 只保留最近的20条记录
                    if (logs.length > 20) {
                        logs = logs.slice(logs.length - 20);
                    }
                    
                    logsRef.set(logs);
                });
        }
        
        // 生成唯一用户ID（基于设备和浏览器）
        function generateUserId() {
            const storedId = localStorage.getItem('petUserId');
            if (storedId) return storedId;
            
            // 生成一个简单的唯一ID
            const newId = 'user_' + Math.random().toString(36).substr(2, 9);
            localStorage.setItem('petUserId', newId);
            return newId;
        }
        
        // 保存用户数据到本地
        function saveUserData() {
            localStorage.setItem('petUsername', currentState.username);
            localStorage.setItem('petRoomCode', currentState.roomCode || '');
        }
        
        // 从本地加载用户数据
        function loadUserData() {
            const username = localStorage.getItem('petUsername');
            const roomCode = localStorage.getItem('petRoomCode');
            
            if (username) {
                currentState.username = username;
                usernameDisplay.textContent = username;
            }
            
            if (roomCode) {
                currentState.roomCode = roomCode;
                roomCodeElem.textContent = roomCode;
                subscribeToRoomChanges(roomCode);
            }
        }
        
        // 请求通知权限
        function requestNotificationPermission() {
            if ('Notification' in window) {
                Notification.requestPermission().then(permission => {
                    if (permission === 'granted') {
                        showToast('通知权限已开启');
                        scheduleReminder();
                    }
                });
            }
        }
        
        // 设置每日提醒
        function scheduleReminder() {
            // 检查通知权限
            if (Notification.permission !== 'granted') return;
            
            // 清除之前的定时器（如果有）
            if (window.reminderTimeout) {
                clearTimeout(window.reminderTimeout);
            }
            
            // 设置下一个提醒时间（晚上8点）
            const now = new Date();
            const reminderTime = new Date(now);
            reminderTime.setHours(20, 0, 0, 0);
            
            // 如果今天的提醒时间已过，设置为明天
            if (now > reminderTime) {
                reminderTime.setDate(reminderTime.getDate() + 1);
            }
            
            const timeUntilReminder = reminderTime.getTime() - now.getTime();
            
            // 设置定时器
            window.reminderTimeout = setTimeout(() => {
                if (!currentState.todayInteracted) {
                    new Notification('别忘了续火花', {
                        body: '今天还没有与伴侣互动，快去续火花吧！',
                        icon: '/favicon.ico'
                    });
                }
                
                // 设置下一天的提醒
                scheduleReminder();
            }, timeUntilReminder);
        }
        
        // 复制房间代码
        copyBtn.addEventListener('click', () => {
            if (!currentState.roomCode) return;
            
            navigator.clipboard.writeText(currentState.roomCode)
                .then(() => {
                    showToast('房间代码已复制');
                })
                .catch(err => {
                    console.error('Could not copy text: ', err);
                });
        });
        
        // 打开加入房间模态框
        enterRoomBtn.addEventListener('click', () => {
            joinRoomModal.style.display = 'flex';
        });
        
        // 取消加入房间
        cancelJoinBtn.addEventListener('click', () => {
            joinRoomModal.style.display = 'none';
        });
        
        // 确认加入房间
        confirmJoinBtn.addEventListener('click', () => {
            const code = roomCodeInput.value.trim().toUpperCase();
            if (!code) {
                showToast('请输入房间代码');
                return;
            }
            
            joinRoom(code);
            joinRoomModal.style.display = 'none';
        });
        
        // 创建新房间
        createRoomBtn.addEventListener('click', () => {
            createRoom();
        });
        
        // 打开修改昵称模态框
        changeNameBtn.addEventListener('click', () => {
            nameInput.value = currentState.username;
            changeNameModal.style.display = 'flex';
        });
        
        // 取消修改昵称
        cancelNameBtn.addEventListener('click', () => {
            changeNameModal.style.display = 'none';
        });
        
        // 确认修改昵称
        confirmNameBtn.addEventListener('click', () => {
            const name = nameInput.value.trim();
            if (!name) {
                showToast('请输入昵称');
                return;
            }
            
            currentState.username = name;
            usernameDisplay.textContent = name;
            saveUserData();
            
            // 如果已在房间中，更新房间中的昵称
            if (currentState.roomCode) {
                const userId = generateUserId();
                database.ref('rooms/' + currentState.roomCode + '/members/' + userId + '/username').set(name)
                    .then(() => {
                        addLog(`${name} 修改了昵称`);
                    });
            }
            
            changeNameModal.style.display = 'none';
            showToast('昵称修改成功');
        });
        
        // 重新领养
        adoptNewBtn.addEventListener('click', () => {
            adoptNewPet();
        });
        
        // 续火花按钮
        sparkBtn.addEventListener('click', () => {
            spark();
        });
        
        // 喂食按钮
        feedBtn.addEventListener('click', () => {
            feed();
        });
        
        // 玩耍按钮
        playBtn.addEventListener('click', () => {
            play();
        });
        
        // 通知设置按钮
        notificationBtn.addEventListener('click', () => {
            requestNotificationPermission();
        });
        
        // 使用Three.js创建3D宠物
        let scene, camera, renderer, pet, mixer, animations;
        let clock = new THREE.Clock();
        
        function initThreeJS() {
            const container = document.getElementById('canvasContainer');
            
            // 创建场景
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0xf8f9fa);
            
            // 创建相机
            camera = new THREE.PerspectiveCamera(75, container.clientWidth / container.clientHeight, 0.1, 1000);
            camera.position.z = 5;
            
            // 创建渲染器
            renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setSize(container.clientWidth, container.clientHeight);
            container.appendChild(renderer.domElement);
            
            // 添加环境光
            const ambientLight = new THREE.AmbientLight(0xffffff, 0.6);
            scene.add(ambientLight);
            
            // 添加定向光
            const directionalLight = new THREE.DirectionalLight(0xffffff, 0.8);
            directionalLight.position.set(1, 1, 1);
            scene.add(directionalLight);
            
            // 创建简单的3D宠物（这里使用简单几何体，实际应用可以加载更复杂的模型）
            createSimplePet();
            
            // 添加轨道控制
            const controls = new THREE.OrbitControls(camera, renderer.domElement);
            controls.enableDamping = true;
            controls.dampingFactor = 0.05;
            controls.screenSpacePanning = false;
            controls.minDistance = 3;
            controls.maxDistance = 8;
            controls.maxPolarAngle = Math.PI / 2;
            
            // 响应窗口大小变化
            window.addEventListener('resize', onWindowResize);
            
            // 开始动画循环
            animate();
        }
        
        // 创建简单的3D宠物
        function createSimplePet() {
            // 创建一个简单的宠物形状
            const group = new THREE.Group();
            
            // 宠物身体
            const bodyGeometry = new THREE.SphereGeometry(1, 32, 32);
            const bodyMaterial = new THREE.MeshLambertMaterial({ color: 0xFF69B4 });
            const body = new THREE.Mesh(bodyGeometry, bodyMaterial);
            group.add(body);
            
            // 宠物头部
            const headGeometry = new THREE.SphereGeometry(0.6, 32, 32);
            const headMaterial = new THREE.MeshLambertMaterial({ color: 0xFF69B4 });
            const head = new THREE.Mesh(headGeometry, headMaterial);
            head.position.y = 1.1;
            head.position.z = 0.3;
            group.add(head);
            
            // 宠物耳朵
            const earGeometry = new THREE.ConeGeometry(0.2, 0.5, 32);
            const earMaterial = new THREE.MeshLambertMaterial({ color: 0xFF1493 });
            
            const leftEar = new THREE.Mesh(earGeometry, earMaterial);
            leftEar.position.set(-0.3, 1.5, 0.3);
            leftEar.rotation.x = -0.5;
            group.add(leftEar);
            
            const rightEar = new THREE.Mesh(earGeometry, earMaterial);
            rightEar.position.set(0.3, 1.5, 0.3);
            rightEar.rotation.x = -0.5;
            group.add(rightEar);
            
            // 宠物眼睛
            const eyeGeometry = new THREE.SphereGeometry(0.1, 32, 32);
            const eyeMaterial = new THREE.MeshBasicMaterial({ color: 0x000000 });
            
            const leftEye = new THREE.Mesh(eyeGeometry, eyeMaterial);
            leftEye.position.set(-0.2, 1.2, 0.8);
            group.add(leftEye);
            
            const rightEye = new THREE.Mesh(eyeGeometry, eyeMaterial);
            rightEye.position.set(0.2, 1.2, 0.8);
            group.add(rightEye);
            
            // 宠物鼻子
            const noseGeometry = new THREE.SphereGeometry(0.08, 32, 32);
            const noseMaterial = new THREE.MeshBasicMaterial({ color: 0x000000 });
            const nose = new THREE.Mesh(noseGeometry, noseMaterial);
            nose.position.set(0, 1.0, 0.9);
            group.add(nose);
            
            // 宠物嘴
            const mouthGeometry = new THREE.TorusGeometry(0.15, 0.03, 16, 32, Math.PI);
            const mouthMaterial = new THREE.MeshBasicMaterial({ color: 0x000000 });
            const mouth = new THREE.Mesh(mouthGeometry, mouthMaterial);
            mouth.position.set(0, 0.9, 0.85);
            mouth.rotation.x = Math.PI / 2;
            group.add(mouth);
            
            // 宠物腿
            const legGeometry = new THREE.CylinderGeometry(0.15, 0.15, 0.5, 32);
            const legMaterial = new THREE.MeshLambertMaterial({ color: 0xFF69B4 });
            
            const frontLeftLeg = new THREE.Mesh(legGeometry, legMaterial);
            frontLeftLeg.position.set(-0.5, -0.75, 0.5);
            group.add(frontLeftLeg);
            
            const frontRightLeg = new THREE.Mesh(legGeometry, legMaterial);
            frontRightLeg.position.set(0.5, -0.75, 0.5);
            group.add(frontRightLeg);
            
            const backLeftLeg = new THREE.Mesh(legGeometry, legMaterial);
            backLeftLeg.position.set(-0.5, -0.75, -0.5);
            group.add(backLeftLeg);
            
            const backRightLeg = new THREE.Mesh(legGeometry, legMaterial);
            backRightLeg.position.set(0.5, -0.75, -0.5);
            group.add(backRightLeg);
            
            // 宠物尾巴
            const tailGeometry = new THREE.CylinderGeometry(0.1, 0.05, 0.5, 32);
            const tailMaterial = new THREE.MeshLambertMaterial({ color: 0xFF1493 });
            const tail = new THREE.Mesh(tailGeometry, tailMaterial);
            tail.position.set(0, 0, -1.2);
            tail.rotation.x = Math.PI / 2;
            group.add(tail);
            
            // 添加到场景
            scene.add(group);
            
            // 保存宠物引用
            pet = group;
            
            // 将宠物放在适当位置
            pet.position.y = -0.5;
            
            // 添加简单动画
            animatePet();
        }
        
        // 简单的宠物动画
        function animatePet() {
            if (!pet) return;
            
            // 使用定时器创建简单动画
            setInterval(() => {
                if (currentState.isAlive) {
                    const time = Date.now() * 0.001;
                    pet.rotation.y = Math.sin(time) * 0.3;
                    pet.position.y = -0.5 + Math.sin(time * 2) * 0.1;
                }
            }, 16);
        }
        
        // 根据宠物状态更新动画
        function updatePetAnimation() {
            if (!pet) return;
            
            if (!currentState.isAlive) {
                // 宠物死亡状态
                pet.rotation.z = Math.PI / 2; // 倒下
                
                // 灰色滤镜
                pet.traverse(child => {
                    if (child.isMesh) {
                        if (child.material.color) {
                            child.material.color.setRGB(0.5, 0.5, 0.5);
                        }
                    }
                });
            } else {
                // 宠物活跃状态
                pet.rotation.z = 0;
                
                // 恢复颜色
                pet.traverse(child => {
                    if (child.isMesh) {
                        if (child.material.name === 'body' || child.material.name === 'head' || child.material.name === 'leg') {
                            child.material.color.setHex(0xFF69B4);
                        } else if (child.material.name === 'ear' || child.material.name === 'tail') {
                            child.material.color.setHex(0xFF1493);
                        }
                    }
                });
                
                // 根据爱心和饱食度调整状态
                const happiness = (currentState.loveValue + currentState.foodValue) / 2;
                
                if (happiness < 30) {
                    // 不开心状态 - 可以添加特殊动画或效果
                } else if (happiness > 80) {
                    // 非常开心状态
                }
            }
        }
        
        // 窗口大小调整
        function onWindowResize() {
            const container = document.getElementById('canvasContainer');
            camera.aspect = container.clientWidth / container.clientHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(container.clientWidth, container.clientHeight);
        }
        
        // 动画循环
        function animate() {
            requestAnimationFrame(animate);
            
            const delta = clock.getDelta();
            if (mixer) mixer.update(delta);
            
            renderer.render(scene, camera);
        }
        
        // 加载应用
        function initApp() {
            loadUserData();
            initThreeJS();
            
            // 请求通知权限
            if (Notification.permission === 'default') {
                setTimeout(() => {
                    requestNotificationPermission();
                }, 3000);
            } else if (Notification.permission === 'granted') {
                scheduleReminder();
            }
            
            hideLoading();
        }
        
        
        // 初始化应用
        window.addEventListener('load', initApp);
    </script>
</body>
</html>